"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _table=require("antd/es/table"),_table2=_interopRequireDefault(_table),_icon=require("antd/es/icon"),_icon2=_interopRequireDefault(_icon),_button=require("antd/es/button"),_button2=_interopRequireDefault(_button),_message2=require("antd/es/message"),_message3=_interopRequireDefault(_message2),_input=require("antd/es/input"),_input2=_interopRequireDefault(_input),_modal=require("antd/es/modal"),_modal2=_interopRequireDefault(_modal),_tabs=require("antd/es/tabs"),_tabs2=_interopRequireDefault(_tabs);require("antd/es/table/style"),require("antd/es/icon/style"),require("antd/es/button/style"),require("antd/es/message/style"),require("antd/es/input/style"),require("antd/es/modal/style"),require("antd/es/tabs/style");var _react=require("react"),_react2=_interopRequireDefault(_react),_antd=require("antd"),_commonUtil=require("../../../../util/commonUtil"),_commonUtil2=_interopRequireDefault(_commonUtil),_fetch=require("../../../../util/fetch"),_fetch2=_interopRequireDefault(_fetch),_tabRouter=require("./../../../../util/tabRouter.js"),_index=require("../../../../constant/index"),_fileUpload=require("./fileUpload"),_fileUpload2=_interopRequireDefault(_fileUpload);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(a){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(a);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}require("./../../../common/style/index.less"),require("./index.less");var TabPane=_tabs2.default.TabPane,confirm=_modal2.default.confirm,TextArea=_input2.default.TextArea,ProcessDesigner=function(){_inherits(a,_react.Component);var t=_createSuper(a);function a(e){var n;return _classCallCheck(this,a),_defineProperty(_assertThisInitialized(n=t.call(this,e)),"editModel",function(e){var t={pathname:"/processManager/ProcessDesigner/modeler/edit",state:{modelId:n.getModelIdByIndex(e)}};(0,_tabRouter.goTo)(t,"编辑流程图")}),_defineProperty(_assertThisInitialized(n),"handleNewModel",function(){n.state.newModelName?n.newModel():n.setState({nameIsNull:!0,newModelFormVisible:!1})}),_defineProperty(_assertThisInitialized(n),"newModel",function(){(0,_fetch2.default)({url:"/"+_index.BACKSTAGE_PROJ_NAME+"/workflow/createModel",data:{name:n.state.newModelName,description:n.state.newModelDesc},success:function(e){var t={pathname:"/processManager/ProcessDesigner/modeler/create",state:{modelId:e.reply.modelId}};n.setState({newModelFormVisible:!1}),(0,_tabRouter.goTo)(t,"新增流程图")}})}),_defineProperty(_assertThisInitialized(n),"changeNewModelFormVisibleState",function(){n.setState({newModelFormVisible:!n.state.newModelFormVisible})}),_defineProperty(_assertThisInitialized(n),"changeImportModalVisibleState",function(){n.setState({importModalVisible:!n.state.importModalVisible})}),_defineProperty(_assertThisInitialized(n),"refreshModelList",function(){var e=_assertThisInitialized(n);n.setState({importModalVisible:!n.state.importModalVisible}),e.getModelList()}),_defineProperty(_assertThisInitialized(n),"handleDeleteModel",function(e){n.showDeleteConfirmModal(e)}),_defineProperty(_assertThisInitialized(n),"handleDeployModel",function(e){n.showDeployConfirmModal(e)}),_defineProperty(_assertThisInitialized(n),"handleExportModel",function(e){var t=n.getModelIdByIndex(e),a=n.getExportUrl(t);window.document.getElementById("downloadFileFrame").src=a}),_defineProperty(_assertThisInitialized(n),"getExportUrl",function(e){return"/"+_index.BACKSTAGE_PROJ_NAME+"/workflow/exportModelBpmnFile.download?modelId="+e}),_defineProperty(_assertThisInitialized(n),"handleNameChange",function(e){var t=e.target.value;n.setState({newModelName:t,nameIsNull:!t})}),_defineProperty(_assertThisInitialized(n),"handleDescChange",function(e){var t=e.target.value;n.setState({newModelDesc:t})}),_defineProperty(_assertThisInitialized(n),"showDeleteConfirmModal",function(e){var t=_assertThisInitialized(n);confirm({title:"你确定要删除本模型吗？",content:"本操作不可撤销",onOk:function(){t.deleteModel(e)}})}),_defineProperty(_assertThisInitialized(n),"showDeployConfirmModal",function(e){var t=_assertThisInitialized(n);confirm({title:"你确定要部署本模型吗？",onOk:function(){t.deployModel(e)}})}),_defineProperty(_assertThisInitialized(n),"deleteModel",function(e){var t=_assertThisInitialized(n),a=n.getModelIdByIndex(e);a&&(0,_fetch2.default)({url:"/"+_index.BACKSTAGE_PROJ_NAME+"/workflow/deleteModel",data:{modelId:a},success:function(){_message3.default.success("删除成功",1),t.getModelList()}})}),_defineProperty(_assertThisInitialized(n),"deployModel",function(e){var t=_assertThisInitialized(n),a=n.getModelIdByIndex(e);a&&(0,_fetch2.default)({url:"/"+_index.BACKSTAGE_PROJ_NAME+"/workflow/deployModel",data:{modelId:a},success:function(){_message3.default.success("部署成功",5),t.getModelList()}})}),_defineProperty(_assertThisInitialized(n),"getModelList",function(e){n.setState({loading:!0}),(0,_fetch2.default)({url:"/"+_index.BACKSTAGE_PROJ_NAME+"/workflow/getModelList"}).then(function(e){var t=e.reply.modelList.map(function(e,t){return e.key=e.id,e});n.setState({modelList:t,loading:!1})})}),_defineProperty(_assertThisInitialized(n),"getModelIdByIndex",function(e){return n.state.modelList[e].id}),n.state={loading:!1,newModelFormVisible:!1,importModalVisible:!1,newModelName:"",newModelDesc:"",nameIsNull:!1,modelList:null,columns:[{title:"模型名称",dataIndex:"name"},{title:"描述",dataIndex:"metaInfo",render:function(e){return _react2.default.createElement("span",null,JSON.parse(e).description)}},{title:"修订号",dataIndex:"revision"},{title:"创建时间",dataIndex:"createTime",render:function(e){return _react2.default.createElement("span",null,_commonUtil2.default.formatDateTime(e))}},{title:"更新时间",dataIndex:"lastUpdateTime",render:function(e){return _react2.default.createElement("span",null,_commonUtil2.default.formatDateTime(e))}},{title:"操作",dataIndex:"",render:function(e,t,a){return _react2.default.createElement("div",null,_react2.default.createElement(_button2.default,{type:"primary",onClick:n.editModel.bind(_assertThisInitialized(n),a),className:"editor-bar-button pandora-btn-fontsize"},"编辑"),_react2.default.createElement(_button2.default,{onClick:n.handleExportModel.bind(_assertThisInitialized(n),a),className:"editor-bar-button  primary is-plain pandora-btn-fontsize"},"导出"),_react2.default.createElement(_button2.default,{onClick:n.handleDeployModel.bind(_assertThisInitialized(n),a),className:"editor-bar-button  primary is-plain pandora-btn-fontsize"},"部署"),_react2.default.createElement(_button2.default,{type:"danger",onClick:n.handleDeleteModel.bind(_assertThisInitialized(n),a),className:"editor-bar-button danger is-plain pandora-btn-fontsize"},"删除"))}}]},n}return _createClass(a,[{key:"componentDidMount",value:function(){this.getModelList()}},{key:"render",value:function(){return _react2.default.createElement("div",{id:"processModelList",className:"pandora-main-content"},_react2.default.createElement("div",{className:"portlet-tab"},_react2.default.createElement(_tabs2.default,{defaultActiveKey:"1",style:{marginBottom:7,height:"100%"}},_react2.default.createElement(TabPane,{tab:"流程设计工作区",key:"1",style:{height:"100%"}},_react2.default.createElement("div",{className:"portlet-body"},_react2.default.createElement("div",{className:"role-table"},_react2.default.createElement("div",{className:"role-header"},_react2.default.createElement("div",{className:"role-create1",onClick:this.changeImportModalVisibleState},_react2.default.createElement(_icon2.default,{className:"role-icon",type:"upload"}),_react2.default.createElement("span",null,"导入")),_react2.default.createElement("div",{className:"role-create1",onClick:this.changeNewModelFormVisibleState},_react2.default.createElement(_icon2.default,{className:"role-icon",type:"plus"}),_react2.default.createElement("span",null,"新建模型")))),_react2.default.createElement(_table2.default,{pagination:!1,loading:this.state.loading,dataSource:this.state.modelList,columns:this.state.columns,style:{paddingLeft:10,paddingRight:10,marginTop:10},size:"middle",rowKey:"id"}))))),_react2.default.createElement(_modal2.default,{title:"新建模型",visible:this.state.newModelFormVisible,onOk:this.handleNewModel,onCancel:this.changeNewModelFormVisibleState},_react2.default.createElement("div",{className:"new-model-input"},_react2.default.createElement(_input2.default,{size:"large",placeholder:"请输入模型名称",value:this.state.newModelName,onChange:this.handleNameChange.bind(this)}),this.state.nameIsNull?_react2.default.createElement("span",{className:"has-error"},"模型名称不能为空"):null),_react2.default.createElement(TextArea,{size:"large",placeholder:"请输入模型描述",value:this.state.newModelDesc,autosize:{minRows:6,maxRows:8},onChange:this.handleDescChange})),_react2.default.createElement(_modal2.default,{title:"导入模型",visible:this.state.importModalVisible,onOk:null,onCancel:null,footer:null,className:"import-model-input"},_react2.default.createElement(_fileUpload2.default,{ref:"bpmnFileUploader",closeModal:this.refreshModelList})),_react2.default.createElement("iframe",{id:"downloadFileFrame",style:{display:"none"}}))}}]),a}();exports.default=ProcessDesigner,module.exports=exports.default;