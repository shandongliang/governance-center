"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _form=require("antd/es/form"),_form2=_interopRequireDefault(_form),_table=require("antd/es/table"),_table2=_interopRequireDefault(_table),_upload=require("antd/es/upload"),_upload2=_interopRequireDefault(_upload),_button=require("antd/es/button"),_button2=_interopRequireDefault(_button),_popconfirm=require("antd/es/popconfirm"),_popconfirm2=_interopRequireDefault(_popconfirm),_modal=require("antd/es/modal"),_modal2=_interopRequireDefault(_modal),_message2=require("antd/es/message"),_message3=_interopRequireDefault(_message2),_tabs=require("antd/es/tabs"),_tabs2=_interopRequireDefault(_tabs);require("antd/es/form/style"),require("antd/es/table/style"),require("antd/es/upload/style"),require("antd/es/button/style"),require("antd/es/popconfirm/style"),require("antd/es/modal/style"),require("antd/es/message/style"),require("antd/es/tabs/style");var _react=require("react"),_react2=_interopRequireDefault(_react),_antd=require("antd"),_$fetch=require("$fetch"),_$fetch2=_interopRequireDefault(_$fetch),_store=require("../../util/store"),_index=require("../../constant/index"),_index2=_interopRequireDefault(_index);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function ownKeys(t,e){var a,r=Object.keys(t);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(t),e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,a)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(a){var r=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(a);return _possibleConstructorReturn(this,r?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}require("./index.less");var TabPane=_tabs2.default.TabPane,FileUploadTable=function(){_inherits(a,_react2.default.Component);var t=_createSuper(a);function a(e){var i;return _classCallCheck(this,a),_defineProperty(_assertThisInitialized(i=t.call(this,e)),"uploadInfoAndFile",function(a,r){return window.FormData?i.uploadAntd(a,r):new Promise(function(e,t){i.uploadIE(a,r,e)})}),_defineProperty(_assertThisInitialized(i),"uploadAntd",function(e,t){e=e||{};var a=new FormData,r=i.props.parentRef.fileListObj;for(var n in r)(function(t){if(0<r[t].length)return r[t].forEach(function(e){a.append(t,e)});a.append(t,"")})(n);for(var o in e)void 0!==e[o]&&null!==e[o]&&("[object Array]"!=Object.prototype.toString.call(e[o])&&"[object Object]"!=Object.prototype.toString.call(e[o])?a.append(o,e[o]):a.append(o,JSON.stringify(e[o])));return i.setState({uploading:!0}),window.formData=a,(0,_$fetch.$uploadfile)({url:t,data:a})}),_defineProperty(_assertThisInitialized(i),"uploadIE",function(e,t,o){var n=_assertThisInitialized(i);for(var a in e)"[object Array]"!=Object.prototype.toString.call(e[a])&&"[object Object]"!=Object.prototype.toString.call(e[a])||(e[a]=JSON.stringify(e[a]));var r={url:t+".upload",type:"POST",data:_objectSpread({},e),dataType:"json",header:{},success:function(e){var t=e.reply.returnCode.type,a=e.reply.returnCode.code,r=e.reply.returnCode.message,n=a===r?t+" : "+a:t+" : "+a+" : "+r;"S"==t&&($(".file-upload-table-input-container .selected").remove(),_message3.default.success("上传成功",5)),"E"==t&&_modal2.default.warning({title:n}),o(e)},error:function(e,t,a){_modal2.default.warning({title:a})},uploadProgress:function(e,t,a,r){100==r?n.setState({uploading:!1}):n.setState({uploading:!0})}};return $("#"+i.state.formId).ajaxSubmit(r),!1}),_defineProperty(_assertThisInitialized(i),"getDate",function(e){if(e){var t=new Date(e);return t.getFullYear()+"-"+i.addZero(t.getMonth()+1)+"-"+i.addZero(t.getDate())+" "+i.addZero(t.getHours())+":"+i.addZero(t.getMinutes())+":"+i.addZero(t.getSeconds())}return""}),_defineProperty(_assertThisInitialized(i),"addZero",function(e){return e<10?"0"+e:e}),_defineProperty(_assertThisInitialized(i),"handleDelete",function(r){var e,t,a,n,o;r.upload&&!i.props.deleteWhenSubmit?(e=_objectSpread({},r),(0,_$fetch2.default)({url:i.props.deleteApi,data:e}).then(function(e){var t,a;"S"==e.reply.returnCode.type?(t=i.state.data.filter(function(e){return e.id!=r.id}),a=i.state.fileListData.filter(function(e){return e.id!=r.id}),i.setState({data:t,fileListData:a}),_message3.default.success("附件删除成功")):_message3.default.success("附件删除失败")})):r.upload&&i.props.deleteWhenSubmit?(i.props.parentRef.realDeleteObj[i.props.attachmentName+"_delete"].push(_objectSpread({},r)),t=i.state.data.filter(function(e){return e.attachmentName!=r.attachmentName}),a=i.state.fileList.filter(function(e){return e.name!=r.attachmentName}),i.setState({data:t,fileList:a})):(n=i.state.data.filter(function(e){return e.attachmentName!=r.attachmentName}),o=i.state.fileList.filter(function(e){return e.name!=r.attachmentName}),i.setState({data:n,fileList:o}))}),_defineProperty(_assertThisInitialized(i),"downLoad",function(e){var t="?";for(var a in e)"upload"!=a&&"key"!=a&&(t+="".concat(a,"=").concat(e[a],"&"));t=t.slice(0,-1);var r=i.props.downLoadApi+t;window.document.getElementById("downloadFileFrame").src=encodeURI(encodeURI(r))}),_defineProperty(_assertThisInitialized(i),"queryFileList",function(e,t){var a=[],r=e.fileListData;if(r)for(var n=0;n<r.length;n++)i.state.data.find(function(e){return e.key==r[n].id})||a.push(_objectSpread(_objectSpread({},r[n]),{},{upload:!0,key:r[n].id}));t?i.setState({data:[].concat(_toConsumableArray(i.state.data),a),fileListData:r||_toConsumableArray(i.state.fileListData)}):i.state.data=[].concat(_toConsumableArray(i.state.data),a)}),_defineProperty(_assertThisInitialized(i),"fileUploadStaticIe",function(a){var o=_assertThisInitialized(i),e=++i.state.fileId;a.prepend('<input id="selectFile_'+e+'" name="'+i.props.attachmentName+'" type="file" style="z-index:1;"/>');var t=a.find('input[type="file"]').first();return t.change(function(){var r=this,e=$(this).val(),n=o.getFileName(e);return o.state.data.find(function(e){return e.attachmentName==n})?(alert("您上传的文件名重复，请核对！"),!1):o.state.fileList.length>=o.props.maxUploadFilesNum?(alert("您最多只能上传 "+o.props.maxUploadFilesNum+" 个文件"),!1):($(this).addClass("selected"),void o.setState(function(e){var t=e.data,a=e.fileList;return{fileList:[].concat(_toConsumableArray(a),[o.getFileName($(r).val())]),data:[].concat(_toConsumableArray(t),[{key:Math.random(),upload:!1,attachmentName:n,uploadUser:_store.authStore.get(_index2.default.AUTH_USER_INFO).userName,uploadTime:Date.now()}])}},function(){o.props.isAutoUpLoad&&o.props.autoUpLoadApi?o.uploadInfoAndFile(o.props.autoUpLoadApi.data,o.props.autoUpLoadApi.url).then(function(t){var e;o.props.attachmentName&&"[object Array]"==Object.prototype.toString.call(t.reply.attachmentList[o.props.attachmentName])&&(e=o.state.data.map(function(e){return e.attachmentName==t.reply.attachmentList[o.props.attachmentName][0].attachmentName?_objectSpread(_objectSpread({},t.reply.attachmentList[o.props.attachmentName][0]),{},{upload:!0,key:t.reply.attachmentList[o.props.attachmentName][0].id}):e}),o.setState({data:e},function(){o.fileUploadStaticIe(a)}))}):o.fileUploadStaticIe(a)}))}),t}),_defineProperty(_assertThisInitialized(i),"getFileName",function(e){var t="",t=-1!=e.indexOf("/")?"/":"\\",a=e.lastIndexOf(t);return e.substr(a+1)}),i.state={fileList:[],uploading:!1,data:[],fileId:"0",formId:"upload"+Date.now(),fileListData:[],columns:[{title:"附件名称",dataIndex:"attachmentName",width:"50%"},{title:"上传人",dataIndex:"uploadUser",width:"15%"},{title:"上传时间",dataIndex:"uploadTime",width:"20%",render:function(e){return _react2.default.createElement("span",null,i.getDate(e))}},{title:"操作",dataIndex:"operation",render:function(e,t){return _react2.default.createElement("span",null,_react2.default.createElement(_popconfirm2.default,{title:"确定删除?",onConfirm:function(){return i.handleDelete(t)}},_react2.default.createElement("a",null,"show"==i.props.type?"删除":"")),"  ",_react2.default.createElement("a",{onClick:function(){i.downLoad(t)}},!t.upload||"show"!=i.props.type&&"readonly"!=i.props.type?"":"下载"))}}]},i}return _createClass(a,[{key:"shouldComponentUpdate",value:function(e){return 0==this.state.fileListData.length&&e.fileListData&&0<e.fileListData.length&&!this.flag&&(this.state.fileListData=e.fileListData,this.queryFileList(e),this.flag=!0),!0}},{key:"componentDidMount",value:function(){this.queryFileList(this.props,!0);var e=$(".file-upload-table-input-container");this.fileUploadStaticIe(e),this.props.parentRef&&!this.props.parentRef.uploadInfoAndFile&&(this.props.parentRef.uploadInfoAndFile=this.uploadInfoAndFile)}},{key:"render",value:function(){var a=this;this.props.parentRef&&(this.props.parentRef.fileListObj=this.props.parentRef.fileListObj||{},this.props.parentRef.realDeleteObj=this.props.parentRef.realDeleteObj||{},this.props.parentRef.fileTableData=this.props.parentRef.fileTableData||{},this.props.parentRef.attachmentName=this.props.attachmentName||"",this.props.parentRef.realDeleteObj[this.props.attachmentName+"_delete"]=this.props.parentRef.realDeleteObj[this.props.attachmentName+"_delete"]||[],this.props.parentRef.fileListObj[this.props.attachmentName]=this.state.fileList,this.props.parentRef.fileTableData[this.props.attachmentName]=this.state.data);var e={multiple:!this.props.isAutoUpLoad||!this.props.autoUpLoadApi,beforeUpload:function(r){var e=/\\([^\\]+)$/.exec(r.name),n=e?e[1]:r.name;return a.state.data.find(function(e){return e.attachmentName==n})?alert("您上传的文件名重复，请核对！"):a.state.fileList.length>=a.props.maxUploadFilesNum?alert("您最多只能上传 "+a.props.maxUploadFilesNum+" 个文件"):a.props.isAutoUpLoad&&a.props.autoUpLoadApi?a.setState(function(e){e.fileList;var t=e.data;return{fileList:[r],data:[].concat(_toConsumableArray(t),[{key:Math.random(),upload:!1,attachmentName:n,uploadUser:_store.authStore.get(_index2.default.AUTH_USER_INFO).userName,uploadTime:Date.now()}])}},function(){a.uploadInfoAndFile(a.props.autoUpLoadApi.data,a.props.autoUpLoadApi.url).then(function(t){var e;a.props.attachmentName&&"[object Array]"==Object.prototype.toString.call(t.reply.attachmentList[a.props.attachmentName])&&(e=a.state.data.map(function(e){return e.attachmentName==t.reply.attachmentList[a.props.attachmentName][0].attachmentName?_objectSpread(_objectSpread({},t.reply.attachmentList[a.props.attachmentName][0]),{},{upload:!0,key:t.reply.attachmentList[a.props.attachmentName][0].id}):e}),a.setState({data:e,fileList:[]}))})}):a.setState(function(e){var t=e.fileList,a=e.data;return{fileList:[].concat(_toConsumableArray(t),[r]),data:[].concat(_toConsumableArray(a),[{key:Math.random(),upload:!1,attachmentName:n,uploadUser:_store.authStore.get(_index2.default.AUTH_USER_INFO).userName,uploadTime:Date.now()}])}}),!1}};return"hidden"!==this.props.type?window.FormData?_react2.default.createElement(_tabs2.default,{className:"upload-attachment-tabs",tabBarExtraContent:"show"==this.props.type?_react2.default.createElement(_upload2.default,_extends({},e,{showUploadList:!1}),_react2.default.createElement(_button2.default,{type:"primary",className:"file-upload-btn"},"上传附件")):""},_react2.default.createElement(TabPane,{className:"upload-attachment-tab-pane",tab:"附件",key:"3"},_react2.default.createElement("div",{className:"portlet-body"},_react2.default.createElement(_table2.default,{className:"upload-attachment-tabs-table",rowClassName:function(){return"upload-attachment-tabs-table-row"},bordered:!0,dataSource:this.state.data,columns:this.state.columns,pagination:!1,rowKey:"id",style:{marginBottom:"7px"}}),_react2.default.createElement("iframe",{id:"downloadFileFrame",style:{display:"none"}})))):_react2.default.createElement(_form2.default,{encType:"multipart/form-data",id:this.state.formId},_react2.default.createElement(_tabs2.default,{className:"upload-attachment-tabs",tabBarExtraContent:"show"==this.props.type?_react2.default.createElement("div",{style:{position:"relative"}},_react2.default.createElement(_button2.default,{className:"file-picker1 pandora-btn-fontsize",type:"primary",style:{marginLeft:"5px",width:"70px",height:"26px",lineHeight:"26px",borderRadius:"5px",background:"#108ee9",color:"white",position:"absolute",right:0,zIndex:0,padding:0}},"上传附件"),_react2.default.createElement("div",{className:"file-upload-table-input-container"})):""},_react2.default.createElement(TabPane,{className:"upload-attachment-tab-pane",tab:"附件",key:"4"},_react2.default.createElement("div",{className:"portlet-body"},_react2.default.createElement(_table2.default,{bordered:!0,className:"upload-attachment-tabs-table",rowClassName:function(){return"upload-attachment-tabs-table-row"},dataSource:this.state.data,columns:this.state.columns,pagination:!1,rowKey:"id",style:{marginBottom:"7px"}}),_react2.default.createElement("iframe",{id:"downloadFileFrame",style:{display:"none"}}))))):_react2.default.createElement("div",null)}}]),a}();exports.default=FileUploadTable,module.exports=exports.default;