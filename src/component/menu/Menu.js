"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _menu4=require("antd/es/menu"),_menu5=_interopRequireDefault(_menu4),_icon=require("antd/es/icon"),_icon2=_interopRequireDefault(_icon),_input=require("antd/es/input"),_input2=_interopRequireDefault(_input);require("antd/es/menu/style"),require("antd/es/icon/style"),require("antd/es/input/style");var _react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_rcAnimate=require("rc-animate"),_rcAnimate2=_interopRequireDefault(_rcAnimate),_antd=require("antd"),_pathToRegexp=require("path-to-regexp"),_pathToRegexp2=_interopRequireDefault(_pathToRegexp),_menu6=require("./../../util/menu"),_addRemoveClass=require("./../../util/addRemoveClass"),_addRemoveClass2=_interopRequireDefault(_addRemoveClass),_reactRouterDom=require("react-router-dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(u)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}require("./index.less");var Search=_input2.default.Search,Menus=function(){_inherits(h,_react.Component);var f=_createSuper(h);function h(e){var u;_classCallCheck(this,h),_defineProperty(_assertThisInitialized(u=f.call(this,e)),"levelMap",{}),_defineProperty(_assertThisInitialized(u),"getPathArray",function(r,e,n,a){var o=[];return function e(t){t&&t[n]&&(o.unshift(String(t[n])),e((0,_menu6.queryArray)(r,t[n],a)))}(e),o}),_defineProperty(_assertThisInitialized(u),"getMenuTree",function(e){return(0,_menu6.arrayToTree)(e,"menuId","parentMenuId")}),_defineProperty(_assertThisInitialized(u),"isArrayInclude",function(e,t){for(var r=0;r<e.length;r++)if(e[r].menuId==t.menuId)return!0;return!1}),_defineProperty(_assertThisInitialized(u),"getMenus",function(e,t){var r=u.getMenuTree(u.state.menu);return e.map(function(e){return e.children?(e.parentMenuId&&(u.levelMap[e.menuId]=e.parentMenuId),_react2.default.createElement(_menu5.default.SubMenu,{key:e.menuId,title:_react2.default.createElement("span",null,e.tab&&_react2.default.createElement(_icon2.default,{type:e.tab}),(!t||!u.isArrayInclude(r,e))&&e.menuName)},u.getMenus(e.children,t))):_react2.default.createElement(_menu5.default.Item,{key:e.menuId},e.tab&&_react2.default.createElement(_icon2.default,{type:e.tab}),(!t||!u.isArrayInclude(r,e))&&e.menuName)})}),_defineProperty(_assertThisInitialized(u),"getAncestorKeys",function(e){var t={};for(var r in u.levelMap)!{}.hasOwnProperty.call(u.levelMap,r)||(t[r]=function e(t){var r=[String(u.levelMap[t])];if(u.levelMap[r[0]])for(var n=e(r[0]);0<n.length;)r.unshift(n.pop());return r}(r));return t[e]||[]}),_defineProperty(_assertThisInitialized(u),"onOpenChange",function(e){var t=u.state,r=e.find(function(e){return!t.openKeys.includes(e)}),n=[];r?n=u.getAncestorKeys(r).concat(r):0<e.length&&(n=e),u.setState({openKeys:n})}),_defineProperty(_assertThisInitialized(u),"handleClick",function(t){return function(e){var r=e.key,n="/";u.setState({current:r}),t.map(function(e){var t;e.menuId==r&&((t=e.action).indexOf("http://")<0&&t.indexOf("https://")<0&&t.indexOf("/")<0&&(t="/"+t.replace(/\./g,"/")),n=t,e.menuName)}),-1<n.indexOf("http://")||-1<n.indexOf("https://")?window.open(n,"_blank"):u.props.history.push(n),u.props.handleCallback&&u.props.handleCallback()}}),_defineProperty(_assertThisInitialized(u),"shouldRemoveScrollClass",function(){clearTimeout(u.timer),u.timer=setTimeout(function(){clearTimeout(u.timer);var e=Array.from(u.hideIeScrollEle.getElementsByTagName("div")).find(function(e){return"true"==e.getAttribute("aria-expanded")});parseInt(getComputedStyle(u.hideIeScrollEle,null).width)<=42&&!e?_addRemoveClass2.default.removeClass(u.hideIeScrollEle,"ieScrollStyle"):_addRemoveClass2.default.addClass(u.hideIeScrollEle,"ieScrollStyle")},1e3)}),_defineProperty(_assertThisInitialized(u),"handleSearchMenu",function(t){var r=u.props.menuData;if(""!==t){var n={},e=r.filter(function(e){if(-1<e.menuName.indexOf(t))return n[e.menuId]=e,!0});if(0===e.length)u.setState({menu:[]});else{e.map(function(e){u.getContextMenuItem(e,r,n)});var a=[];for(var o in n)a.push(n[o]);u.setState({menu:a})}}else u.setState({menu:r})}),_defineProperty(_assertThisInitialized(u),"getContextMenuItem",function(e,t,r){for(var n=e.menuId,a=e.parentMenuId,o=0;o<t.length;o++){var i=t[o];i.parentMenuId===n&&(r.hasOwnProperty(i.menuId)||(r[i.menuId]=i,u.getChildMenuItem(i,t,r))),i.menuId===a&&(r.hasOwnProperty(i.menuId)||(r[i.menuId]=i,u.getParentMenuItem(i,t,r)))}}),_defineProperty(_assertThisInitialized(u),"getParentMenuItem",function(e,t,r){for(var n=e.parentMenuId,a=0;a<t.length;a++){var o=t[a];o.menuId===n&&(r.hasOwnProperty(o.menuId)||(r[o.menuId]=o,u.getParentMenuItem(o,t,r)))}}),_defineProperty(_assertThisInitialized(u),"getChildMenuItem",function(e,t,r){for(var n=e.menuId,a=0;a<t.length;a++){var o=t[a];o.parentMenuId===n&&(r.hasOwnProperty(o.menuId)||(r[o.menuId]=o,u.getChildMenuItem(o,t,r)))}});var t,r=u.props.menuData;if(!r||"[object Array]"==Object.prototype.toString.call(r)&&0===r.length||"undefined"===r)return _possibleConstructorReturn(u,!1);var n,a="M0000000000000000001",o=[],i=location.hash,l=location.pathname,s=i.indexOf("?"),c="",c=0<s?i.substring(1,s):i.substring(1),d=_createForOfIteratorHelper(r);try{for(d.s();!(n=d.n()).done;){var p=n.value;if(p.action.indexOf("http://")<0&&p.action.indexOf("https://")<0){if(p.action="/"+p.action.replace(/\./g,"/"),p.action&&(0,_pathToRegexp2.default)(p.action).exec(c)){t=p;break}}else if(p.action&&"/"!=l&&p.action.indexOf(l)){t=p;break}}}catch(e){d.e(e)}finally{d.f()}return t?(a=t.menuId,o="horizontal"===u.props.mode?[]:u.getPathArray(r,t,"parentMenuId","menuId")):u.props.history.replace("/"),u.state={siderFold:e.siderFold,darkTheme:e.darkTheme,menu:r,current:a,openKeys:o},u}return _createClass(h,[{key:"componentWillReceiveProps",value:function(e){if(e.location.pathname!=this.props.location.pathname){var t=this.state&&this.state.menu;if(!t||"[object Array]"==Object.prototype.toString.call(t)&&0===t.length||"undefined"===t)return!1;var r,n,a=e.location.pathname,o=(0,_menu6.getCurMenu)(a);o?(r=o.menuId,n=this.getPathArray(t,o,"parentMenuId","menuId"),this.setState({siderFold:e.siderFold,darkTheme:e.darkTheme,current:r,openKeys:n}),"horizontal"==this.props.mode&&this.setState({openKeys:[]})):this.setState({siderFold:e.siderFold,darkTheme:e.darkTheme})}else this.setState({siderFold:e.siderFold,darkTheme:e.darkTheme})}},{key:"componentDidUpdate",value:function(){-1<window.navigator.userAgent.indexOf("Trident")&&this.shouldRemoveScrollClass()}},{key:"componentDidMount",value:function(){var t=this;-1<window.navigator.userAgent.indexOf("Trident")&&(this.hideIeScrollEle=document.getElementsByClassName("pandora-menu")[0],_addRemoveClass2.default.addClass(this.hideIeScrollEle,"ieScrollStyle"),this.hideIeScrollEle.onclick=function(e){"I"==((e=e||window.event).target||e.srcElement).tagName&&t.shouldRemoveScrollClass()})}},{key:"render",value:function(){var e=this.state&&this.state.menu,t=this.props.searchMenu||!1,r=!!this.state&&this.state.siderFold;if(e&&"[object Array]"==Object.prototype.toString.call(e)&&0!=e.length&&"undefined"!==e){var n=this.state,a=n.darkTheme,o=n.menu,i=(0,_menu6.arrayToTree)(o,"menuId","parentMenuId"),u=this.getMenus(i,r),l={openKeys:this.state.openKeys,onOpenChange:this.onOpenChange},s="inline";"vertial"==this.props.mode?s=r?"vertial":"inline":"horizontal"==this.props.mode&&(s="horizontal");var c="pandora-menu spread-menu";return!r&&t?c="pandora-menu spread-menu":(r||t)&&!r||(c="pandora-menu shrink-menu"),_react2.default.createElement("div",null,t&&!r&&_react2.default.createElement(Search,{className:"menu-search",placeholder:"搜索菜单",onSearch:this.handleSearchMenu}),_react2.default.createElement(_menu5.default,_extends({},l,{mode:s,theme:a,selectedKeys:[this.state.current],onClick:this.handleClick(o),className:c}),u))}return t&&!r?_react2.default.createElement("div",null,_react2.default.createElement(Search,{className:"menu-search",placeholder:"搜索菜单",onSearch:this.handleSearchMenu}),_react2.default.createElement("p",{style:{lineHeight:10,textAlign:"center",fontSize:14}},"暂无数据")):null}}]),h}();_defineProperty(Menus,"propTypes",{menu:_propTypes2.default.array,siderFold:_propTypes2.default.bool,darkTheme:_propTypes2.default.string,isNavbar:_propTypes2.default.bool,handleClickNavMenu:_propTypes2.default.func,navOpenKeys:_propTypes2.default.array,changeOpenKeys:_propTypes2.default.func,searchMenu:_propTypes2.default.bool}),exports.default=(0,_reactRouterDom.withRouter)(Menus),module.exports=exports.default;